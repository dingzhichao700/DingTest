package {
	import flash.display.Sprite;
	import flash.events.KeyboardEvent;
	import flash.events.MouseEvent;
	import flash.geom.Point;
	
	import utils.Dispatcher;

	public class BlockPainter {
		
		public var blocks:Sprite;
		private var dotList:Array;
		private var block1:Array = [[1, 0],[1544, 0],[1550, 1079],[1, 1079],[37, 6],[140, 7],[172, 24],[296, 33],[295, 126],[328, 125],[325, 18],[902, 25],[900, 108],[619, 123],[595, 254],[631, 261],[631, 136],[919, 124],[942, 22],[1501, 32],[1509, 579],[1365, 602],[1356, 810],[1089, 816],[1083, 600],[1057, 597],[1079, 831],[1367, 828],[1388, 800],[1391, 617],[1508, 618],[1505, 1068],[1238, 1071],[1240, 967],[1392, 964],[1385, 934],[1216, 947],[1210, 1068],[1102, 1071],[1082, 942],[936, 927],[919, 818],[756, 813],[760, 841],[902, 844],[909, 924],[767, 937],[743, 1042],[632, 1045],[632, 720],[901, 717],[940, 682],[936, 257],[1208, 255],[1200, 356],[1248, 363],[1234, 244],[1082, 214],[1091, 134],[1356, 134],[1357, 460],[1091, 463],[1088, 345],[1040, 346],[1068, 470],[1206, 506],[1206, 708],[1240, 710],[1239, 504],[1382, 460],[1380, 122],[1061, 121],[1045, 227],[750, 229],[761, 265],[906, 253],[903, 350],[474, 340],[480, 118],[441, 115],[449, 228],[178, 223],[181, 119],[134, 118],[158, 240],[445, 256],[464, 355],[900, 375],[902, 689],[464, 692],[464, 613],[635, 608],[634, 579],[441, 595],[440, 709],[603, 726],[601, 952],[629, 952],[629, 1045],[295, 1049],[293, 1070],[176, 1070],[187, 958],[454, 951],[486, 908],[484, 854],[448, 815],[334, 797],[331, 488],[741, 487],[749, 605],[788, 600],[772, 472],[741, 457],[369, 460],[331, 433],[326, 362],[293, 345],[141, 339],[143, 366],[291, 378],[293, 577],[164, 584],[135, 723],[178, 722],[186, 602],[291, 611],[305, 825],[445, 854],[443, 918],[380, 934],[150, 944],[143, 1067],[24, 1064],[27, 841],[189, 841],[181, 815],[24, 805],[24, 494],[188, 491],[190, 467],[21, 458],[0, 1079]];	
		private var block2:Array = [[0, 0],[1526, 0],[1528, 1079],[0, 1079],[19, 1072],[1455, 1073],[1453, 1016],[1292, 1014],[1292, 959],[1454, 959],[1454, 410],[1370, 412],[1369, 530],[1293, 531],[1293, 355],[1454, 355],[1452, 173],[1295, 172],[1290, 116],[1455, 117],[1454, 56],[713, 51],[712, 171],[547, 174],[550, 118],[637, 116],[638, 53],[155, 52],[156, 6],[65, 7],[68, 354],[228, 355],[229, 475],[316, 474],[313, 355],[475, 354],[476, 292],[315, 293],[315, 174],[229, 173],[228, 292],[153, 292],[153, 114],[475, 115],[475, 173],[389, 171],[391, 237],[799, 235],[798, 115],[1208, 114],[1209, 173],[1047, 175],[1046, 235],[1369, 235],[1369, 291],[1210, 293],[1210, 594],[1367, 594],[1368, 895],[1045, 898],[1046, 956],[1209, 959],[1208, 1015],[797, 1014],[799, 896],[391, 895],[393, 1016],[153, 1015],[153, 897],[67, 897],[67, 1016],[19, 1016],[17, 1071],[479, 1072],[475, 958],[713, 959],[713, 1014],[550, 1015],[553, 1074],[16, 1070],[0, 1079]];	
		private var block3:Array = [[1528, 1079],[1527, 128],[1461, 127],[1462, 867],[1335, 867],[1329, 822],[1398, 820],[1400, 777],[1272, 776],[1268, 917],[1460, 916],[1461, 1050],[1020, 1051],[1019, 961],[893, 960],[890, 913],[955, 913],[954, 822],[1019, 821],[1018, 776],[889, 775],[890, 681],[763, 680],[761, 730],[825, 729],[825, 823],[891, 823],[888, 867],[824, 868],[826, 1007],[951, 1009],[952, 1052],[510, 1051],[510, 914],[636, 913],[636, 820],[696, 821],[698, 959],[572, 961],[574, 1005],[765, 1006],[765, 775],[700, 775],[700, 683],[573, 682],[573, 636],[505, 635],[507, 728],[635, 731],[636, 773],[570, 774],[572, 867],[316, 867],[315, 961],[383, 962],[382, 914],[444, 914],[443, 1047],[380, 1048],[381, 1006],[315, 1004],[317, 1050],[66, 1049],[66, 1007],[17, 1005],[18, 959],[65, 960],[64, 916],[129, 912],[127, 864],[65, 868],[66, 730],[318, 731],[319, 683],[64, 680],[63, 638],[130, 633],[130, 591],[61, 589],[64, 542],[127, 542],[129, 500],[62, 497],[62, 451],[190, 450],[189, 404],[62, 406],[64, 267],[189, 268],[191, 219],[253, 224],[252, 312],[125, 312],[124, 359],[320, 360],[318, 173],[124, 173],[126, 221],[63, 220],[63, 37],[252, 37],[251, 81],[128, 82],[127, 129],[319, 129],[317, 38],[635, 37],[634, 127],[573, 127],[572, 83],[381, 83],[380, 406],[253, 406],[253, 497],[188, 500],[189, 636],[379, 637],[380, 775],[125, 774],[126, 822],[188, 822],[188, 959],[127, 961],[126, 1008],[256, 1006],[254, 823],[511, 820],[510, 773],[446, 774],[445, 496],[379, 496],[381, 591],[190, 590],[190, 545],[318, 543],[317, 450],[444, 452],[447, 313],[381, 314],[381, 266],[571, 267],[571, 220],[446, 220],[445, 127],[507, 129],[508, 176],[701, 175],[701, 82],[634, 81],[635, 37],[760, 36],[760, 79],[827, 83],[827, 37],[889, 38],[890, 83],[954, 83],[954, 36],[1270, 37],[1270, 82],[1334, 84],[1334, 128],[1271, 126],[1269, 174],[1333, 175],[1333, 219],[1268, 219],[1270, 359],[1333, 360],[1336, 404],[1210, 405],[1210, 81],[1142, 83],[1142, 126],[1081, 125],[1081, 83],[1016, 83],[1015, 127],[951, 128],[951, 175],[1208, 177],[1208, 221],[892, 220],[890, 129],[762, 129],[762, 175],[824, 175],[823, 220],[762, 221],[762, 267],[825, 267],[825, 311],[700, 312],[700, 221],[634, 221],[635, 314],[505, 312],[506, 452],[571, 452],[571, 359],[892, 359],[889, 267],[1141, 270],[1143, 313],[952, 313],[954, 362],[1016, 362],[1015, 591],[957, 592],[953, 405],[760, 405],[762, 543],[826, 545],[826, 453],[888, 453],[888, 589],[701, 588],[698, 404],[635, 405],[635, 497],[698, 499],[698, 544],[573, 542],[573, 498],[506, 498],[506, 592],[632, 593],[633, 637],[952, 637],[952, 730],[1080, 730],[1081, 821],[1142, 822],[1144, 867],[1017, 869],[1016, 915],[1080, 916],[1080, 1009],[1401, 1009],[1399, 959],[1146, 959],[1144, 916],[1209, 914],[1209, 775],[1144, 773],[1144, 730],[1273, 731],[1271, 683],[1335, 683],[1334, 729],[1400, 729],[1400, 591],[1334, 591],[1332, 637],[1207, 636],[1207, 680],[1020, 682],[1018, 637],[1145, 638],[1144, 590],[1079, 589],[1081, 362],[1143, 361],[1144, 544],[1208, 545],[1207, 589],[1274, 591],[1272, 544],[1462, 543],[1462, 496],[1142, 498],[1144, 450],[1400, 452],[1399, 309],[1338, 313],[1337, 267],[1398, 267],[1400, 38],[1462, 37],[1460, 78],[1513, 83],[1512, 126],[1527, 127],[1527, 84],[1525, 0],[0, 0],[0, 1079]];	
		private var blockDotList:Array;
		
		private static var instance:BlockPainter;
		public static function getInstance():BlockPainter {
			instance ||= new BlockPainter();
			return instance;
		}
		
		public function BlockPainter() {
		}
		
		public function initMission(mission:int):void {
			blockDotList = [block1, block2, block3];
//			stage.addEventListener(MouseEvent.CLICK, onClick);
			Dispatcher.addListener(KeyEvent.KEY_DOWN, onDown);
			
			blocks ||= new Sprite();
			blocks.graphics.clear();
			LayerManager.getInstance().LAYER_PLAYER.addChild(blocks);
			
			var targetBlock:Array = blockDotList[mission-1];
			if(targetBlock && targetBlock.length > 0){
				dotList = [];
				for(var i:int = 0; i < targetBlock.length;i++){
					dotList.push(new Point(targetBlock[i][0], targetBlock[i][1]));
				}
				paintBlock();
			} else {
				dotList = [];
			}
		}
		
		private function onClick(e:MouseEvent):void {
			var point:Point = new Point(e.stageX, e.stageY);
			addDot(point);
		}
		
		private function onDown(e:KeyboardEvent):void {
			if(e.keyCode == 90 && e.ctrlKey){//ctrl+z，撤回
				deleteDot();
			}
			if(e.keyCode == 84 && e.ctrlKey){//ctrl+t,画障碍
				paintBlock();
			}
			if(e.keyCode == 83 && e.ctrlKey){//ctrl+s,保存点位
				geneDots();
			}
			if(e.keyCode == 82){//r,清画布
				dotList = [];
				blocks && blocks.graphics.clear();
			}
		}
		
		private function addDot(point:Point):void {
			dotList.push(point);
//			paintDots();
			paintBlock();
		}
		
		private function deleteDot():void {
			if(dotList && dotList.length > 0){
				dotList.pop();
			}
//			paintDots();
			paintBlock();
		}
		
		/**画点*/
		private function paintDots(needClear:Boolean = true):void {
			if(needClear){
				blocks.graphics.clear();
			}
			blocks.graphics.beginFill(0x00ff00);
			for(var i:int = 0; i < dotList.length; i++){
				blocks.graphics.drawCircle((dotList[i] as Point).x, (dotList[i] as Point).y, 3);
			}
		}
		
		/**画障碍*/
		private function paintBlock():void {
			blocks.graphics.clear();
			blocks.graphics.beginFill(0xff0000, 0.5);
			if(dotList.length >= 3){
				blocks.graphics.moveTo((dotList[i] as Point).x, (dotList[i] as Point).y);
				for(var i:int = 0; i < dotList.length; i++){
					blocks.graphics.lineTo((dotList[i] as Point).x, (dotList[i] as Point).y);
				}
			}
			blocks.visible = false;
//			paintDots(false);
		}
		
		private function geneDots():void {
			var outStr:String = "[";
			for(var i:int = 0; i < dotList.length; i++){
				outStr += "[" + (dotList[i] as Point).x + ", " + (dotList[i] as Point).y + "]";
				if(i != (dotList.length-1)){
					outStr += ",";
				}
			}
			outStr += "]";
			trace("保存完毕");
		}
	}
}
