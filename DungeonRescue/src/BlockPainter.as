package {
	import flash.display.Sprite;
	import flash.events.KeyboardEvent;
	import flash.events.MouseEvent;
	import flash.geom.Point;
	
	import utils.Dispatcher;

	public class BlockPainter {
		
		public var blocks:Sprite;
		private var dotList:Array;
		private var block1:Array = [[31, 31],[0, 0],[1522, 1],[1522, 1079],[0, 1079],[0, 0],[27, 32],[22, 468],[119, 453],[155, 471],[160, 489],[131, 506],[47, 490],[19, 493],[19, 817],[117, 808],[147, 813],[162, 839],[113, 848],[19, 837],[15, 1061],[107, 1063],[113, 946],[133, 931],[309, 932],[405, 921],[418, 878],[403, 849],[345, 836],[303, 837],[266, 819],[262, 799],[256, 631],[216, 606],[160, 611],[139, 658],[148, 727],[115, 739],[91, 711],[106, 673],[110, 603],[153, 578],[239, 571],[260, 542],[260, 392],[223, 373],[148, 381],[114, 374],[100, 355],[127, 339],[275, 353],[301, 375],[304, 445],[345, 465],[682, 458],[727, 463],[751, 489],[767, 584],[754, 616],[739, 619],[714, 609],[710, 585],[722, 547],[713, 505],[676, 486],[329, 490],[305, 501],[290, 530],[295, 776],[309, 797],[329, 808],[403, 813],[434, 827],[453, 854],[456, 885],[454, 915],[436, 939],[399, 955],[225, 953],[183, 959],[147, 988],[141, 1061],[258, 1061],[261, 1046],[294, 1034],[597, 1040],[599, 950],[567, 948],[570, 738],[420, 717],[391, 691],[393, 616],[432, 580],[596, 575],[613, 586],[613, 607],[591, 623],[538, 608],[450, 612],[431, 636],[445, 688],[468, 700],[841, 695],[879, 661],[875, 396],[843, 376],[467, 375],[423, 359],[412, 333],[415, 287],[394, 266],[348, 256],[143, 259],[107, 232],[101, 164],[96, 124],[114, 110],[136, 110],[153, 129],[146, 211],[181, 234],[376, 235],[411, 211],[414, 184],[401, 130],[419, 114],[441, 114],[456, 138],[442, 300],[450, 327],[477, 349],[805, 351],[843, 346],[867, 336],[880, 301],[865, 271],[831, 258],[744, 277],[720, 269],[712, 253],[719, 232],[743, 227],[963, 239],[1002, 229],[1027, 203],[1030, 141],[1079, 116],[1327, 118],[1364, 136],[1375, 176],[1372, 438],[1364, 462],[1332, 483],[1232, 494],[1215, 525],[1221, 716],[1200, 727],[1177, 715],[1180, 502],[1138, 488],[1061, 488],[1027, 456],[1021, 350],[1050, 340],[1069, 357],[1060, 399],[1064, 456],[1087, 468],[1281, 463],[1312, 451],[1335, 430],[1338, 408],[1337, 180],[1329, 157],[1309, 142],[1104, 140],[1067, 155],[1055, 181],[1063, 212],[1090, 231],[1203, 239],[1221, 263],[1222, 319],[1234, 359],[1219, 377],[1185, 378],[1167, 364],[1186, 308],[1176, 267],[1143, 256],[972, 258],[923, 274],[908, 317],[910, 686],[898, 709],[861, 724],[638, 721],[605, 735],[598, 1040],[690, 1046],[725, 1024],[725, 959],[750, 933],[852, 922],[879, 898],[879, 862],[851, 839],[750, 846],[722, 833],[725, 813],[750, 805],[870, 813],[910, 829],[909, 898],[917, 916],[943, 928],[1053, 930],[1079, 980],[1080, 1064],[1186, 1065],[1177, 972],[1194, 939],[1231, 928],[1377, 936],[1380, 962],[1220, 962],[1215, 982],[1219, 1062],[1487, 1065],[1490, 656],[1480, 630],[1454, 614],[1385, 623],[1367, 647],[1376, 783],[1363, 814],[1334, 833],[1298, 842],[1111, 842],[1060, 833],[1041, 817],[1030, 795],[1033, 591],[1059, 591],[1063, 793],[1081, 809],[1118, 815],[1298, 812],[1329, 796],[1344, 755],[1335, 614],[1356, 591],[1481, 578],[1494, 547],[1494, 78],[1469, 34],[1429, 24],[955, 24],[923, 37],[911, 64],[911, 112],[889, 140],[858, 150],[625, 148],[598, 179],[605, 264],[584, 273],[560, 256],[575, 143],[605, 121],[861, 115],[881, 82],[874, 45],[832, 24],[306, 28],[291, 54],[301, 120],[290, 144],[262, 149],[243, 137],[240, 113],[267, 59],[249, 34],[216, 26]];	
		private var block2:Array = [[65, 25],[0, 0],[1523, 0],[1527, 1079],[0, 1079],[0, 0],[65, 28],[68, 352],[229, 355],[231, 474],[314, 474],[314, 356],[476, 355],[474, 293],[313, 290],[312, 175],[229, 171],[228, 291],[152, 290],[153, 118],[476, 117],[475, 172],[391, 173],[391, 234],[800, 236],[797, 118],[1208, 117],[1208, 174],[876, 173],[877, 290],[553, 292],[553, 410],[389, 410],[391, 530],[226, 532],[227, 591],[798, 594],[799, 534],[475, 529],[475, 474],[798, 474],[800, 411],[638, 411],[638, 357],[877, 356],[877, 475],[969, 474],[969, 356],[1047, 354],[1047, 716],[1209, 719],[1208, 778],[969, 775],[970, 532],[876, 531],[877, 776],[796, 776],[799, 650],[551, 651],[553, 775],[473, 777],[478, 651],[389, 651],[389, 775],[315, 776],[313, 652],[150, 650],[152, 412],[67, 414],[66, 720],[227, 721],[228, 778],[67, 777],[67, 839],[227, 840],[228, 1016],[152, 1014],[153, 897],[66, 896],[67, 1015],[19, 1015],[19, 1016],[17, 1068],[477, 1069],[477, 1015],[312, 1014],[315, 840],[638, 837],[637, 719],[713, 721],[715, 838],[876, 841],[878, 955],[970, 960],[968, 841],[1293, 840],[1292, 651],[1131, 650],[1131, 294],[969, 291],[970, 235],[1370, 236],[1370, 291],[1208, 292],[1209, 592],[1371, 595],[1371, 896],[1045, 897],[1046, 958],[1208, 959],[1210, 1015],[799, 1016],[799, 897],[392, 896],[391, 1014],[477, 1015],[476, 958],[715, 957],[715, 1014],[551, 1015],[552, 1071],[1454, 1073],[1454, 1017],[1294, 1014],[1293, 960],[1454, 958],[1455, 413],[1369, 413],[1371, 531],[1292, 529],[1292, 355],[1456, 354],[1454, 174],[1292, 172],[1291, 117],[1454, 115],[1454, 54],[714, 53],[715, 171],[549, 172],[550, 116],[641, 115],[639, 55],[154, 54],[155, 24]];	
		private var block3:Array = [[1528, 1079],[1527, 128],[1461, 127],[1462, 867],[1335, 867],[1329, 822],[1398, 820],[1400, 777],[1272, 776],[1268, 917],[1460, 916],[1461, 1050],[1020, 1051],[1019, 961],[893, 960],[890, 913],[955, 913],[954, 822],[1019, 821],[1018, 776],[889, 775],[890, 681],[763, 680],[761, 730],[825, 729],[825, 823],[891, 823],[888, 867],[824, 868],[826, 1007],[951, 1009],[952, 1052],[510, 1051],[510, 914],[636, 913],[636, 820],[696, 821],[698, 959],[572, 961],[574, 1005],[765, 1006],[765, 775],[700, 775],[700, 683],[573, 682],[573, 636],[505, 635],[507, 728],[635, 731],[636, 773],[570, 774],[572, 867],[316, 867],[315, 961],[383, 962],[382, 914],[444, 914],[443, 1047],[380, 1048],[381, 1006],[315, 1004],[317, 1050],[66, 1049],[66, 1007],[17, 1005],[18, 959],[65, 960],[64, 916],[129, 912],[127, 864],[65, 868],[66, 730],[318, 731],[319, 683],[64, 680],[63, 638],[130, 633],[130, 591],[61, 589],[64, 542],[127, 542],[129, 500],[62, 497],[62, 451],[190, 450],[189, 404],[62, 406],[64, 267],[189, 268],[191, 219],[253, 224],[252, 312],[125, 312],[124, 359],[320, 360],[318, 173],[124, 173],[126, 221],[63, 220],[63, 37],[252, 37],[251, 81],[128, 82],[127, 129],[319, 129],[317, 38],[635, 37],[634, 127],[573, 127],[572, 83],[381, 83],[380, 406],[253, 406],[253, 497],[188, 500],[189, 636],[379, 637],[380, 775],[125, 774],[126, 822],[188, 822],[188, 959],[127, 961],[126, 1008],[256, 1006],[254, 823],[511, 820],[510, 773],[446, 774],[445, 496],[379, 496],[381, 591],[190, 590],[190, 545],[318, 543],[317, 450],[444, 452],[447, 313],[381, 314],[381, 266],[571, 267],[571, 220],[446, 220],[445, 127],[507, 129],[508, 176],[701, 175],[701, 82],[634, 81],[635, 37],[760, 36],[760, 79],[827, 83],[827, 37],[889, 38],[890, 83],[954, 83],[954, 36],[1270, 37],[1270, 82],[1334, 84],[1334, 128],[1271, 126],[1269, 174],[1333, 175],[1333, 219],[1268, 219],[1270, 359],[1333, 360],[1336, 404],[1210, 405],[1210, 81],[1142, 83],[1142, 126],[1081, 125],[1081, 83],[1016, 83],[1015, 127],[951, 128],[951, 175],[1208, 177],[1208, 221],[892, 220],[890, 129],[762, 129],[762, 175],[824, 175],[823, 220],[762, 221],[762, 267],[825, 267],[825, 311],[700, 312],[700, 221],[634, 221],[635, 314],[505, 312],[506, 452],[571, 452],[571, 359],[892, 359],[889, 267],[1141, 270],[1143, 313],[952, 313],[954, 362],[1016, 362],[1015, 591],[957, 592],[953, 405],[760, 405],[762, 543],[826, 545],[826, 453],[888, 453],[888, 589],[701, 588],[698, 404],[635, 405],[635, 497],[698, 499],[698, 544],[573, 542],[573, 498],[506, 498],[506, 592],[632, 593],[633, 637],[952, 637],[952, 730],[1080, 730],[1081, 821],[1142, 822],[1144, 867],[1017, 869],[1016, 915],[1080, 916],[1080, 1009],[1401, 1009],[1399, 959],[1146, 959],[1144, 916],[1209, 914],[1209, 775],[1144, 773],[1144, 730],[1273, 731],[1271, 683],[1335, 683],[1334, 729],[1400, 729],[1400, 591],[1334, 591],[1332, 637],[1207, 636],[1207, 680],[1020, 682],[1018, 637],[1145, 638],[1144, 590],[1079, 589],[1081, 362],[1143, 361],[1144, 544],[1208, 545],[1207, 589],[1274, 591],[1272, 544],[1462, 543],[1462, 496],[1142, 498],[1144, 450],[1400, 452],[1399, 309],[1338, 313],[1337, 267],[1398, 267],[1400, 38],[1462, 37],[1460, 78],[1513, 83],[1512, 126],[1527, 127],[1527, 84],[1525, 0],[0, 0],[0, 1079]];	
		private var blockDotList:Array;

		
		private static var instance:BlockPainter;
		public static function getInstance():BlockPainter {
			instance ||= new BlockPainter();
			return instance;
		}
		
		public function BlockPainter() {
		}
		
		public function initMission(mission:int):void {
			blockDotList = [block1, block2, block3];
//			LayerManager.getInstance().stage.addEventListener(MouseEvent.CLICK, onClick);
			Dispatcher.addListener(KeyEvent.KEY_DOWN, onDown);
			
			blocks ||= new Sprite();
			blocks.graphics.clear();
			LayerManager.getInstance().LAYER_PLAYER.addChild(blocks);
			
			var targetBlock:Array = blockDotList[mission-1];
			if(targetBlock && targetBlock.length > 0){
				dotList = [];
				for(var i:int = 0; i < targetBlock.length;i++){
					dotList.push(new Point(targetBlock[i][0], targetBlock[i][1]));
				}
				paintBlock();
			} else {
				dotList = [];
			}
		}
		
		private function onClick(e:MouseEvent):void {
			var point:Point = new Point(e.stageX, e.stageY);
			addDot(point);
		}
		
		private function onDown(e:KeyboardEvent):void {
			if(e.keyCode == 90 && e.ctrlKey){//ctrl+z，撤回
				deleteDot();
			}
			if(e.keyCode == 84 && e.ctrlKey){//ctrl+t,画障碍
				paintBlock();
			}
			if(e.keyCode == 83 && e.ctrlKey){//ctrl+s,保存点位
				geneDots();
			}
			if(e.keyCode == 82){//r,清画布
				dotList = [];
				blocks && blocks.graphics.clear();
			}
		}
		
		private function addDot(point:Point):void {
			dotList.push(point);
//			paintDots();
			paintBlock();
		}
		
		private function deleteDot():void {
			if(dotList && dotList.length > 0){
				dotList.pop();
			}
//			paintDots();
			paintBlock();
		}
		
		/**画点*/
		private function paintDots(needClear:Boolean = true):void {
			if(needClear){
				blocks.graphics.clear();
			}
			blocks.graphics.beginFill(0x00ff00);
			for(var i:int = 0; i < dotList.length; i++){
				blocks.graphics.drawCircle((dotList[i] as Point).x, (dotList[i] as Point).y, 3);
			}
		}
		
		/**画障碍*/
		private function paintBlock():void {
			blocks.graphics.clear();
			blocks.graphics.beginFill(0xff0000, 0.5);
			if(dotList.length >= 3){
				blocks.graphics.moveTo((dotList[i] as Point).x, (dotList[i] as Point).y);
				for(var i:int = 0; i < dotList.length; i++){
					blocks.graphics.lineTo((dotList[i] as Point).x, (dotList[i] as Point).y);
				}
			}
			blocks.visible = false;//控制阻挡显示
//			paintDots(false);
		}
		
		private function geneDots():void {
			var outStr:String = "[";
			for(var i:int = 0; i < dotList.length; i++){
				outStr += "[" + (dotList[i] as Point).x + ", " + (dotList[i] as Point).y + "]";
				if(i != (dotList.length-1)){
					outStr += ",";
				}
			}
			outStr += "]";
			trace("保存完毕");
		}
	}
}
